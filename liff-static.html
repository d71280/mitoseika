<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´æˆ¸é’æœ - æ³¨æ–‡ã‚·ã‚¹ãƒ†ãƒ ï¼ˆLIFFç‰ˆï¼‰</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f0fdf4 0%, #eff6ff 100%);
            min-height: 100vh;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            flex-direction: column;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="liff-app">
        <div class="loading">
            <div class="spinner"></div>
            <p class="mt-4 text-gray-600">LIFFåˆæœŸåŒ–ä¸­...</p>
        </div>
    </div>

    <script>
        // LIFF ID - å›ºå®šå€¤
        const LIFF_ID = '2007611355-MbZ09XRP';

        // å•†å“ãƒ‡ãƒ¼ã‚¿
        const products = [
            { id: 'prod_cabbage', name: 'ã‚­ãƒ£ãƒ™ãƒ„', unit: 'å€‹', salePrice: 150 },
            { id: 'prod_cucumber', name: 'ãã‚…ã†ã‚Š', unit: 'å€‹', salePrice: 2000 },
            { id: 'prod_hakusai', name: 'ç™½èœ', unit: 'å€‹', salePrice: 300 },
            { id: 'prod_carrot', name: 'äººå‚', unit: 'å€‹', salePrice: 250 },
            { id: 'prod_daikon', name: 'å¤§æ ¹', unit: 'å€‹', salePrice: 160 },
            { id: 'prod_lettuce', name: 'ãƒ¬ã‚¿ã‚¹', unit: 'å€‹', salePrice: 180 },
            { id: 'prod_potato', name: 'ã˜ã‚ƒãŒã„ã‚‚ï¼ˆãƒ¡ãƒ¼ã‚¯ã‚¤ãƒ³ï¼‰', unit: 'å€‹', salePrice: 200 },
            { id: 'prod_tomato', name: 'ãƒˆãƒãƒˆ', unit: 'å€‹', salePrice: 1200 },
            { id: 'prod_onion', name: 'ç‰ã­ã', unit: 'å€‹', salePrice: 300 }
        ].sort((a, b) => a.name.localeCompare(b.name, 'ja'));

        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿
        const clients = [
            { id: 'client_AStore', customerId: '0001', companyName: 'Aå•†åº—', contactPerson: 'å±±ç”° å¤ªéƒ', phone: '03-1234-5678' },
            { id: 'client_BDiner', customerId: '0002', companyName: 'Bé£Ÿå ‚', contactPerson: 'ä½è—¤ èŠ±å­', phone: '03-9876-5432' },
            { id: 'client_CVegeShop', customerId: '0003', companyName: 'Cé’æœåº—', contactPerson: 'ç”°ä¸­ ä¸€éƒ', phone: '029-111-2222' },
            { id: 'client_NewHotel', customerId: '0004', companyName: 'æ°´æˆ¸ãƒ‹ãƒ¥ãƒ¼ãƒ›ãƒ†ãƒ«', contactPerson: 'éˆ´æœ¨ æ¬¡éƒ', phone: '029-333-4444' }
        ];

        let userProfile = null;
        let selectedClient = null;
        let productQuantities = {};
        let isLiffReady = false;

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ç®¡ç†
        function showLoading(message = 'LIFFåˆæœŸåŒ–ä¸­...') {
            document.getElementById('liff-app').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p class="mt-4 text-gray-600">${message}</p>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('liff-app').innerHTML = `
                <div class="max-w-md mx-auto p-6 bg-white rounded-lg shadow-lg mt-20">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-red-600 text-2xl">âš ï¸</span>
                        </div>
                        <h2 class="text-xl font-bold text-red-800 mb-2">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
                        <p class="text-red-600 mb-4">${message}</p>
                        <button onclick="initializeLiff()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                            å†è©¦è¡Œ
                        </button>
                    </div>
                </div>
            `;
        }

        // LIFFåˆæœŸåŒ–
        function initializeLiff() {
            console.log('=== LIFFèªè¨¼ãƒ‡ãƒãƒƒã‚°é–‹å§‹ ===');
            console.log('LIFF ID:', LIFF_ID);
            console.log('ç¾åœ¨ã®URL:', window.location.href);
            console.log('ãƒ—ãƒ­ãƒˆã‚³ãƒ«:', window.location.protocol);
            console.log('ãƒ›ã‚¹ãƒˆ:', window.location.host);
            console.log('ãƒ‘ã‚¹:', window.location.pathname);
            console.log('User Agent:', navigator.userAgent);
            console.log('æ™‚åˆ»:', new Date().toLocaleString('ja-JP'));
            
            // ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLç¢ºèª
            const expectedEndpoint = 'https://mitoseika-9g7rkl4f6-daiki-akiyama-90515-projects.vercel.app/';
            console.log('æœŸå¾…ã•ã‚Œã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:', expectedEndpoint);
            console.log('URLãƒãƒƒãƒãƒ³ã‚°:', window.location.href.startsWith(expectedEndpoint));
            
            showLoading('LINEèªè¨¼ã‚’ç¢ºèªä¸­...');

            if (typeof liff === 'undefined') {
                console.error('LIFF SDKæœªèª­ã¿è¾¼ã¿');
                showError('LIFF SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            console.log('LIFF SDKç¢ºèª:', {
                liffExists: typeof liff !== 'undefined',
                liffVersion: liff?.getVersion ? liff.getVersion() : 'unknown'
            });

            liff.init({ liffId: LIFF_ID })
                .then(() => {
                    console.log('LIFFåˆæœŸåŒ–æˆåŠŸ');
                    
                    if (!liff.isLoggedIn()) {
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªãƒ­ã‚°ã‚¤ãƒ³ - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«é·ç§»');
                        showLoading('LINEèªè¨¼ç”»é¢ã«ç§»å‹•ä¸­...');
                        liff.login();
                        return;
                    }

                    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿');
                    isLiffReady = true;
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
                    return liff.getProfile();
                })
                .then(profile => {
                    if (profile) {
                        userProfile = profile;
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—æˆåŠŸ:', profile);
                    }
                    renderApp();
                })
                .catch(err => {
                    console.error('LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', err);
                    let errorMessage = 'LIFFåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                    
                    if (err.message) {
                        errorMessage = err.message;
                    }
                    
                    showError(errorMessage);
                });
        }

        // ã‚¢ãƒ—ãƒªæç”»
        function renderApp() {
            console.log('ã‚¢ãƒ—ãƒªæç”»é–‹å§‹');
            const app = document.getElementById('liff-app');
            app.innerHTML = `
                <div class="max-w-4xl mx-auto p-4">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                        <div class="text-center mb-6">
                            <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center mx-auto mb-3">
                                <span class="text-white font-bold text-xl">æ°´</span>
                            </div>
                            <h1 class="text-2xl font-bold text-green-800">æ°´æˆ¸é’æœ æ³¨æ–‡ã‚·ã‚¹ãƒ†ãƒ </h1>
                            ${userProfile ? `<p class="text-sm text-green-600 mt-2">ã‚ˆã†ã“ãã€${userProfile.displayName}ã•ã‚“</p>` : ''}
                            <div class="flex items-center justify-center mt-2">
                                <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                                <span class="text-sm text-green-600">LINEèªè¨¼æ¸ˆã¿</span>
                            </div>
                        </div>

                        <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
                        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h3 class="font-bold text-blue-800 mb-2">ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
                            <div class="text-xs space-y-1">
                                <p><strong>ç¾åœ¨ã®URL:</strong> ${window.location.href}</p>
                                <p><strong>LIFF ID:</strong> ${LIFF_ID}</p>
                                <p><strong>èªè¨¼çŠ¶æ…‹:</strong> ${isLiffReady ? 'âœ… æˆåŠŸ' : 'âŒ æœªèªè¨¼'}</p>
                                <p><strong>LIFFç’°å¢ƒ:</strong> ${typeof liff !== 'undefined' && liff.isInClient() ? 'LINEå†…' : 'å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶'}</p>
                                <p><strong>ãƒ—ãƒ­ãƒˆã‚³ãƒ«:</strong> ${window.location.protocol}</p>
                                <p><strong>ãƒ›ã‚¹ãƒˆ:</strong> ${window.location.host}</p>
                                <p><strong>æ™‚åˆ»:</strong> ${new Date().toLocaleString('ja-JP')}</p>
                                <p><strong>ç‰ˆæ•°:</strong> ãƒ‡ãƒãƒƒã‚°ç‰ˆ v1.0</p>
                            </div>
                        </div>

                        <!-- é¡§å®¢IDå…¥åŠ› -->
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-3">é¡§å®¢æƒ…å ±</h2>
                            <div class="mb-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    é¡§å®¢ID <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="customerId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500" placeholder="ä¾‹: 0001" onchange="handleCustomerIdChange()">
                                <div id="error-message" class="mt-1 text-sm text-red-600 hidden"></div>
                            </div>
                            <div id="customer-info" class="bg-gray-50 p-3 rounded-lg hidden">
                                <h3 class="font-medium text-gray-800 mb-2">é¡§å®¢æƒ…å ±</h3>
                                <div id="customer-details" class="grid grid-cols-1 gap-1 text-sm"></div>
                            </div>
                        </div>

                        <!-- å•†å“æ³¨æ–‡ -->
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-3">å•†å“æ³¨æ–‡</h2>
                            <div id="product-list" class="space-y-3"></div>
                            
                            <!-- åˆè¨ˆ -->
                            <div class="mt-4 p-3 bg-green-50 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-gray-800">åˆè¨ˆé‡‘é¡</span>
                                    <span id="total-amount" class="text-xl font-bold text-green-800">Â¥0</span>
                                </div>
                            </div>
                        </div>

                        <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
                        <div class="flex flex-col gap-3">
                            <button id="submit-btn" onclick="submitOrder()" disabled class="w-full py-3 text-lg bg-gray-300 text-gray-500 rounded-md cursor-not-allowed">
                                æ³¨æ–‡ã‚’é€ä¿¡
                            </button>
                            <button onclick="clearForm()" class="w-full py-2 bg-gray-200 text-gray-900 rounded-md hover:bg-gray-300">
                                ã‚¯ãƒªã‚¢
                            </button>
                        </div>
                    </div>
                </div>
            `;

            renderProducts();
        }

        // å•†å“ãƒªã‚¹ãƒˆæç”»
        function renderProducts() {
            const productList = document.getElementById('product-list');
            productList.innerHTML = products.map(product => `
                <div class="border border-gray-200 rounded-lg p-3">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium text-gray-800">${product.name}</h3>
                        <span class="text-sm text-gray-600">Â¥${product.salePrice.toLocaleString()}/${product.unit}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input type="number" id="qty-${product.id}" min="0" class="w-16 px-2 py-1 border border-gray-300 rounded text-center" onchange="updateQuantity('${product.id}', this.value)">
                            <span class="ml-1 text-sm">${product.unit}</span>
                        </div>
                        <div class="text-right">
                            <span id="subtotal-${product.id}" class="text-gray-400">-</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // é¡§å®¢IDå¤‰æ›´å‡¦ç†
        function handleCustomerIdChange() {
            const customerId = document.getElementById('customerId').value;
            const errorDiv = document.getElementById('error-message');
            const customerInfo = document.getElementById('customer-info');
            const customerDetails = document.getElementById('customer-details');

            if (customerId) {
                const client = clients.find(c => c.customerId === customerId);
                if (client) {
                    selectedClient = client;
                    customerDetails.innerHTML = `
                        <div><span class="font-medium">ä¼šç¤¾å:</span> ${client.companyName}</div>
                        <div><span class="font-medium">æ‹…å½“è€…:</span> ${client.contactPerson}</div>
                        <div><span class="font-medium">é›»è©±:</span> ${client.phone}</div>
                    `;
                    customerInfo.classList.remove('hidden');
                    errorDiv.classList.add('hidden');
                    updateSubmitButton();
                } else {
                    selectedClient = null;
                    customerInfo.classList.add('hidden');
                    errorDiv.textContent = 'é¡§å®¢IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                    errorDiv.classList.remove('hidden');
                    updateSubmitButton();
                }
            } else {
                selectedClient = null;
                customerInfo.classList.add('hidden');
                errorDiv.classList.add('hidden');
                updateSubmitButton();
            }
        }

        // æ•°é‡æ›´æ–°
        function updateQuantity(productId, value) {
            const quantity = parseInt(value) || 0;
            productQuantities[productId] = quantity;
            
            const product = products.find(p => p.id === productId);
            const subtotal = quantity * product.salePrice;
            const subtotalElement = document.getElementById(`subtotal-${productId}`);
            
            if (quantity > 0) {
                subtotalElement.textContent = `Â¥${subtotal.toLocaleString()}`;
                subtotalElement.className = 'font-medium';
            } else {
                subtotalElement.textContent = '-';
                subtotalElement.className = 'text-gray-400';
            }
            
            updateTotal();
            updateSubmitButton();
        }

        // åˆè¨ˆæ›´æ–°
        function updateTotal() {
            let total = 0;
            Object.entries(productQuantities).forEach(([productId, quantity]) => {
                if (quantity > 0) {
                    const product = products.find(p => p.id === productId);
                    total += product.salePrice * quantity;
                }
            });
            document.getElementById('total-amount').textContent = `Â¥${total.toLocaleString()}`;
        }

        // é€ä¿¡ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submit-btn');
            const hasItems = Object.values(productQuantities).some(qty => qty > 0);
            
            if (selectedClient && hasItems) {
                submitBtn.disabled = false;
                submitBtn.className = 'w-full py-3 text-lg bg-green-600 text-white rounded-md hover:bg-green-700';
                submitBtn.textContent = 'æ³¨æ–‡ã‚’é€ä¿¡';
            } else {
                submitBtn.disabled = true;
                submitBtn.className = 'w-full py-3 text-lg bg-gray-300 text-gray-500 rounded-md cursor-not-allowed';
                submitBtn.textContent = 'æ³¨æ–‡ã‚’é€ä¿¡';
            }
        }

        // æ³¨æ–‡é€ä¿¡
        function submitOrder() {
            if (!selectedClient) {
                alert('é¡§å®¢IDã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const orderItems = [];
            let totalAmount = 0;

            Object.entries(productQuantities).forEach(([productId, quantity]) => {
                if (quantity > 0) {
                    const product = products.find(p => p.id === productId);
                    const itemTotal = product.salePrice * quantity;
                    orderItems.push({
                        productName: product.name,
                        quantity: quantity,
                        unit: product.unit,
                        unitPrice: product.salePrice,
                        totalPrice: itemTotal
                    });
                    totalAmount += itemTotal;
                }
            });

            if (orderItems.length === 0) {
                alert('å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // LINEã«æ³¨æ–‡å†…å®¹ã‚’é€ä¿¡
            const orderMessage = `ã€æ³¨æ–‡å®Œäº†ã€‘
é¡§å®¢: ${selectedClient.companyName}
æ‹…å½“è€…: ${selectedClient.contactPerson}

ã€æ³¨æ–‡å†…å®¹ã€‘
${orderItems.map(item => `${item.productName} ${item.quantity}${item.unit} Â¥${item.totalPrice.toLocaleString()}`).join('\n')}

åˆè¨ˆ: Â¥${totalAmount.toLocaleString()}

æ³¨æ–‡æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}`;

            if (isLiffReady && liff.isApiAvailable('sendMessages')) {
                liff.sendMessages([{
                    type: 'text',
                    text: orderMessage
                }]).then(() => {
                    alert('æ³¨æ–‡ã‚’LINEã«é€ä¿¡ã—ã¾ã—ãŸï¼');
                    clearForm();
                }).catch(err => {
                    console.error('LINEé€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
                    alert('LINEé€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ³¨æ–‡å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚');
                    navigator.clipboard.writeText(orderMessage);
                    clearForm();
                });
            } else {
                alert('æ³¨æ–‡å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚LINEã§é€ä¿¡ã—ã¦ãã ã•ã„ã€‚');
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(orderMessage);
                }
                clearForm();
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
        function clearForm() {
            document.getElementById('customerId').value = '';
            selectedClient = null;
            productQuantities = {};
            
            // UIæ›´æ–°
            document.getElementById('customer-info').classList.add('hidden');
            document.getElementById('error-message').classList.add('hidden');
            
            products.forEach(product => {
                document.getElementById(`qty-${product.id}`).value = '';
                document.getElementById(`subtotal-${product.id}`).textContent = '-';
                document.getElementById(`subtotal-${product.id}`).className = 'text-gray-400';
            });
            
            updateTotal();
            updateSubmitButton();
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«LIFFåˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMèª­ã¿è¾¼ã¿å®Œäº† - LIFFåˆæœŸåŒ–é–‹å§‹');
            initializeLiff();
        });
    </script>
</body>
</html>